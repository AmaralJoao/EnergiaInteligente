<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivos</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg1: #0b0f20;
            --bg2: #31165a;
            --card-bg: rgba(6,8,20,0.85);
            --accent-a: #00f0ff;
            --accent-b: #8b5cf6;
            --muted: #9aa3b2;
            --text-primary: #cfe9ff;
            --text-secondary: rgba(200,220,255,0.7);
        }
        * { box-sizing: border-box; margin:0; padding:0; font-family:'Montserrat',sans-serif; }
        body, html { height:100%; background: linear-gradient(135deg,var(--bg1) 0%,#171737 40%,var(--bg2) 100%); color: var(--text-primary); }
        .bg-wrapper { position: fixed; inset:0; pointer-events:none; z-index:1; }
        .streak { position:absolute; width:2px; height:120px; background: linear-gradient(180deg, rgba(0,240,255,0) 0%, rgba(0,240,255,0.95) 50%, rgba(0,240,255,0) 100%); filter: blur(0.6px); opacity:.9; transform: translateY(-30vh); animation: floatStreak 10s linear infinite; }
        .s1 { left:8%; top:20%; animation-duration:11s; }
        .s2 { left:52%; top:10%; animation-duration:13s; }
        .s3 { left:85%; top:40%; animation-duration:9s; }
        .s4 { left:72%; top:64%; animation-duration:12s; }
        @keyframes floatStreak { 0%{transform:translateY(-40vh) scaleY(1);opacity:0}10%{opacity:.9}50%{transform:translateY(20vh) scaleY(1.2);opacity:.9}90%{opacity:0}100%{transform:translateY(40vh) scaleY(1);opacity:0} }

        .main-content { position:relative; z-index:10; padding:30px; min-height:calc(100vh - 80px); margin-top:80px; }
        .page-header { text-align:center; margin-bottom:30px; padding:20px 0; }
        .page-title { font-size:2.2rem; font-weight:700; margin-bottom:10px; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 0 30px rgba(139,92,246,0.3); letter-spacing:1px; }
        .page-subtitle { font-size:1rem; color:var(--text-secondary); font-weight:300; max-width:600px; margin:0 auto; }
        .card-custom { background:var(--card-bg); border-radius:12px; border:1px solid rgba(74,200,255,0.06); position:relative; overflow:hidden; margin-bottom:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .card-header-custom { background: rgba(10,15,35,0.7); border-bottom:1px solid rgba(74,200,255,0.1); padding:20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; }
        .card-title-custom { color: var(--text-primary); font-weight:600; margin:0; font-size:1.3rem; }
        .btn-custom-primary { background: linear-gradient(90deg,var(--accent-a),var(--accent-b)); border:none; color:#0b0f20; font-weight:600; padding:10px 20px; border-radius:8px; transition:all 0.3s ease; box-shadow:0 4px 15px rgba(0,240,255,0.3); white-space:nowrap; }
        .btn-custom-primary:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,240,255,0.4); }
        .btn-custom-secondary { background: rgba(30,40,70,0.7); border:1px solid rgba(74,200,255,0.2); color:var(--text-primary); font-weight:500; padding:8px 16px; border-radius:8px; transition:all 0.3s ease; white-space:nowrap; }
        .btn-custom-secondary:hover { background: rgba(40,50,90,0.7); border-color: rgba(74,200,255,0.4); }
        .btn-custom-info { background: linear-gradient(90deg,#00b894,#00f0ff); border:none; color:#0b0f20; font-weight:600; padding:8px 16px; border-radius:8px; transition:all 0.3s ease; }
        .btn-custom-info:hover { transform:translateY(-2px); box-shadow:0 4px 15px rgba(0,240,255,0.4); }
        .table-custom { background:transparent; color:var(--text-primary); margin-bottom:0; width:100%; }
        .table-custom thead th { background: rgba(10,15,35,0.7); border-bottom:1px solid rgba(74,200,255,0.2); color:var(--accent-a); font-weight:600; padding:12px 15px; position:sticky; top:0; z-index:10; }
        .table-custom tbody td { border-bottom:1px solid rgba(74,200,255,0.1); padding:12px 15px; vertical-align:middle; }
        .table-custom tbody tr:hover { background: rgba(30,40,70,0.3); }
        .badge-custom-success { background: linear-gradient(90deg,#00b894,#00f0ff); color:#0b0f20; font-weight:600; padding:4px 8px; border-radius:12px; font-size:0.75rem; }
        .badge-custom-secondary { background: linear-gradient(90deg,#6c757d,#9aa3b2); color:#0b0f20; font-weight:600; padding:4px 8px; border-radius:12px; font-size:0.75rem; }

        /* Modal customizado */
        .modal-content-custom { background: var(--card-bg); border: 1px solid rgba(74,200,255,0.1); border-radius: 12px; }
        .modal-header-custom { background: rgba(10,15,35,0.7); border-bottom: 1px solid rgba(74,200,255,0.1); }
        .modal-title-custom { color: var(--text-primary); font-weight: 600; }
        .modal-body-custom { color: var(--text-primary); }
        .modal-footer-custom { background: rgba(10,15,35,0.7); border-top: 1px solid rgba(74,200,255,0.1); }

        .form-control-custom { background: rgba(20,25,45,0.7); border: 1px solid rgba(74,200,255,0.2); color: var(--text-primary); border-radius: 8px; }
        .form-control-custom:focus { background: rgba(20,25,45,0.9); border-color: var(--accent-a); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(0,240,255,0.25); }
        .form-control-custom:read-only { background: rgba(30,35,55,0.5); border-color: rgba(74,200,255,0.1); color: var(--text-secondary); }
        .form-label-custom { color: var(--text-primary); font-weight: 500; margin-bottom: 8px; }

        .localizacao-item { background: rgba(20,25,45,0.5); border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--accent-a); }
        .localizacao-header { display: flex; justify-content: between; align-items: center; margin-bottom: 8px; }
        .localizacao-nome { font-weight: 600; color: var(--accent-a); }
        .localizacao-datas { font-size: 0.85rem; color: var(--text-secondary); }
        .loading-spinner { text-align: center; padding: 20px; color: var(--accent-a); }

        .endereco-completo { font-size: 0.85rem; color: var(--text-secondary); }
        .text-muted-custom { color: var(--muted) !important; }
        .codigo-publico { font-family: monospace; font-size: 0.8rem; background: rgba(0,240,255,0.1); padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
<div class="bg-wrapper">
    <div class="streak s1"></div>
    <div class="streak s2"></div>
    <div class="streak s3"></div>
    <div class="streak s4"></div>
</div>

<header th:replace="pages/component/header :: header"></header>

<div class="main-content">
    <div class="container-fluid">
        <div class="page-header">
            <h1 class="page-title">Gerenciamento de Dispositivos</h1>
            <p class="page-subtitle">Visualize e gerencie todos os dispositivos cadastrados no sistema</p>
        </div>

        <div class="row justify-content-center">
            <div class="col-12 col-xl-12">
                <div class="card-custom">
                    <div class="card-header-custom">
                        <h2 class="card-title-custom">Dispositivos Cadastrados</h2>
                        <div>
                            <button type="button" class="btn btn-custom-primary" onclick="abrirModalNovoDispositivo()">
                                <i class="bi bi-plus-circle"></i> Novo Dispositivo
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="contador-resultados mb-3">
                            <span class="text-muted">
                                Mostrando <span id="totalRegistros" th:text="${dispositivos.size()}">0</span> dispositivos
                            </span>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Código Público</th>
                                    <th>Nome</th>
                                    <th>Modelo</th>
                                    <th>Versão</th>
                                    <th>Localização</th>
                                    <th>Endereço</th>
                                    <th width="120px">Ações</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyDispositivos">
                                <tr th:each="dispositivo : ${dispositivos}">
                                    <td>
                                        <span class="text-muted-custom" th:text="${dispositivo.id}">ID</span>
                                    </td>
                                    <td>
                                        <span class="codigo-publico" th:text="${dispositivo.codigoPublicoDispositivo}">Código</span>
                                    </td>
                                    <td>
                                        <strong th:text="${dispositivo.nomeDoDispositivo}">Nome</strong>
                                    </td>
                                    <td th:text="${dispositivo.modeloDispositivo}">Modelo</td>
                                    <td>
                                        <span class="badge-custom-secondary" th:text="${dispositivo.versaoDoDispositivo}">Versão</span>
                                    </td>
                                    <td>
                                        <span th:if="${dispositivo.nomeDaLocalizacaoDoDispositivo}"
                                              th:text="${dispositivo.nomeDaLocalizacaoDoDispositivo}">Localização</span>
                                        <span th:unless="${dispositivo.nomeDaLocalizacaoDoDispositivo}"
                                              class="text-muted-custom">Sem localização</span>
                                    </td>
                                    <td>
                                        <div class="endereco-completo" th:if="${dispositivo.cidade}">
                                            <div th:text="${dispositivo.nomeDaRua} + ', ' + ${dispositivo.numero}">Rua, Número</div>
                                            <div th:text="${dispositivo.cidade}">Cidade</div>
                                            <div th:if="${dispositivo.complemento}"
                                                 th:text="'Comp: ' + ${dispositivo.complemento}">Complemento</div>
                                        </div>
                                        <span th:unless="${dispositivo.cidade}" class="text-muted-custom">Endereço não informado</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-custom-info btn-sm"
                                                th:attr="data-id=${dispositivo.id}"
                                                onclick="abrirModalDetalhes(this)">
                                            <i class="bi bi-clock-history"></i> Histórico
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Histórico de Localizações -->
<div class="modal fade" id="detalhesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-content-custom">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title modal-title-custom">
                    <i class="bi bi-clock-history"></i> Histórico de Localizações
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body modal-body-custom">
                <!-- Informações do Dispositivo -->
                <div class="card-custom mb-4">
                    <div class="card-header-custom">
                        <h6 class="card-title-custom mb-0">Informações do Dispositivo</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">ID:</strong>
                                <span id="detailId" class="ms-2">-</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">Código Público:</strong>
                                <span id="detailCodigoPublico" class="ms-2 codigo-publico">-</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">Nome:</strong>
                                <span id="detailNome" class="ms-2">-</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">Modelo:</strong>
                                <span id="detailModelo" class="ms-2">-</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">Versão:</strong>
                                <span id="detailVersao" class="ms-2 badge-custom-secondary">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Histórico de Localizações -->
                <div class="card-custom">
                    <div class="card-header-custom">
                        <h6 class="card-title-custom mb-0">Histórico de Localizações</h6>
                    </div>
                    <div class="card-body">
                        <div id="localizacoesContainer">
                            <div class="loading-spinner">
                                <i class="bi bi-arrow-repeat spinner"></i> Carregando histórico de localizações...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer modal-footer-custom">
                <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let dispositivoAtualId = null;

    function abrirModalDetalhes(button) {
        const dispositivoId = button.getAttribute('data-id');
        dispositivoAtualId = dispositivoId;

        // Encontrar os dados do dispositivo na linha da tabela
        const linha = button.closest('tr');
        const dispositivoData = {
            id: linha.querySelector('td:nth-child(1)').textContent.trim(),
            codigoPublico: linha.querySelector('td:nth-child(2)').textContent.trim(),
            nome: linha.querySelector('td:nth-child(3)').textContent.trim(),
            modelo: linha.querySelector('td:nth-child(4)').textContent.trim(),
            versao: linha.querySelector('td:nth-child(5)').textContent.trim()
        };

        // Preencher informações básicas do dispositivo
        document.getElementById('detailId').textContent = dispositivoData.id;
        document.getElementById('detailCodigoPublico').textContent = dispositivoData.codigoPublico;
        document.getElementById('detailNome').textContent = dispositivoData.nome;
        document.getElementById('detailModelo').textContent = dispositivoData.modelo;
        document.getElementById('detailVersao').textContent = dispositivoData.versao;

        // Buscar histórico de localizações
        carregarLocalizacoes(dispositivoId);

        // Mostrar modal
        new bootstrap.Modal(document.getElementById('detalhesModal')).show();
    }

    function carregarLocalizacoes(dispositivoId) {
        const container = document.getElementById('localizacoesContainer');
        container.innerHTML = '<div class="loading-spinner"><i class="bi bi-arrow-repeat spinner"></i> Carregando histórico de localizações...</div>';

        fetch(`/home/config/dispositivo/${dispositivoId}/localizacoes`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao carregar localizações');
                }
                return response.json();
            })
            .then(localizacoes => {
                if (localizacoes.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4">Nenhuma localização registrada no histórico deste dispositivo.</div>';
                    return;
                }

                let html = '';
                localizacoes.forEach((localizacao, index) => {
                    const dataInicio = formatarData(localizacao.dataInicio);
                    const dataFim = localizacao.dataFim ? formatarData(localizacao.dataFim) : 'Atual';

                    html += `
                        <div class="localizacao-item">
                            <div class="localizacao-header">
                                <span class="localizacao-nome">
                                    <i class="bi bi-geo-alt"></i>
                                    ${localizacao.nomeDaLocalizacaoDoDispositivo || 'Localização não nomeada'}
                                </span>
                                <span class="badge-custom-secondary">${index + 1}</span>
                            </div>
                            <div class="localizacao-datas">
                                <strong>Período:</strong> ${dataInicio} até ${dataFim}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Erro ao carregar localizações:', error);
                container.innerHTML = '<div class="text-center text-danger py-4">Erro ao carregar histórico de localizações.</div>';
            });
    }

    function formatarData(dataString) {
        if (!dataString) return 'N/A';

        try {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return dataString;
        }
    }

    function abrirModalNovoDispositivo() {
        // Implementar criação de novo dispositivo conforme necessário
        alert('Funcionalidade de novo dispositivo será implementada aqui');
    }

    // Fechar modal quando for fechado
    document.getElementById('detalhesModal').addEventListener('hidden.bs.modal', function () {
        dispositivoAtualId = null;
        document.getElementById('localizacoesContainer').innerHTML = '';
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivos</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg1: #0b0f20;
            --bg2: #31165a;
            --card-bg: rgba(6,8,20,0.85);
            --accent-a: #00f0ff;
            --accent-b: #8b5cf6;
            --muted: #9aa3b2;
            --text-primary: #cfe9ff;
            --text-secondary: rgba(200,220,255,0.7);
        }

        * {
            box-sizing: border-box;
            margin:0;
            padding:0;
            font-family:'Montserrat',sans-serif;
        }

        body, html {
            height:100%;
            background: linear-gradient(135deg,var(--bg1) 0%,#171737 40%,var(--bg2) 100%);
            color: var(--text-primary);
        }

        /* Fundo decorativo */
        .bg-wrapper {
            position: fixed;
            inset:0;
            pointer-events:none;
            z-index:0;
        }

        .streak {
            position:absolute;
            width:2px;
            height:120px;
            background: linear-gradient(180deg, rgba(0,240,255,0) 0%, rgba(0,240,255,0.95) 50%, rgba(0,240,255,0) 100%);
            filter: blur(0.6px);
            opacity:.9;
            transform: translateY(-30vh);
            animation: floatStreak 10s linear infinite;
        }

        .s1 { left:8%; top:20%; animation-duration:11s; }
        .s2 { left:52%; top:10%; animation-duration:13s; }
        .s3 { left:85%; top:40%; animation-duration:9s; }
        .s4 { left:72%; top:64%; animation-duration:12s; }

        @keyframes floatStreak {
            0%{transform:translateY(-40vh) scaleY(1);opacity:0}
            10%{opacity:.9}
            50%{transform:translateY(20vh) scaleY(1.2);opacity:.9}
            90%{opacity:0}
            100%{transform:translateY(40vh) scaleY(1);opacity:0}
        }

        .main-content {
            position:relative;
            z-index:10;
            padding:30px;
            min-height:calc(100vh - 80px);
            margin-top:80px;
        }

        .page-header {
            text-align:center;
            margin-bottom:30px;
            padding:20px 0;
        }

        .page-title {
            font-size:2.2rem;
            font-weight:700;
            margin-bottom:10px;
            background:linear-gradient(90deg,var(--accent-a),var(--accent-b));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            text-shadow:0 0 30px rgba(139,92,246,0.3);
            letter-spacing:1px;
        }

        .page-subtitle {
            font-size:1rem;
            color:var(--text-secondary);
            font-weight:300;
            max-width:600px;
            margin:0 auto;
        }

        .card-custom {
            background:var(--card-bg);
            border-radius:12px;
            border:1px solid rgba(74,200,255,0.06);
            position:relative;
            overflow:visible;
            margin-bottom:20px;
            box-shadow:0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header-custom {
            background: rgba(10,15,35,0.7);
            border-bottom:1px solid rgba(74,200,255,0.1);
            padding:20px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            flex-wrap:wrap;
            gap:15px;
        }

        .card-title-custom {
            color: var(--text-primary);
            font-weight:600;
            margin:0;
            font-size:1.3rem;
        }

        .btn-custom-primary {
            background: linear-gradient(90deg,var(--accent-a),var(--accent-b));
            border:none;
            color:#0b0f20;
            font-weight:600;
            padding:10px 20px;
            border-radius:8px;
            transition:all 0.3s ease;
            box-shadow:0 4px 15px rgba(0,240,255,0.3);
            white-space:nowrap;
        }

        .btn-custom-primary:hover {
            transform:translateY(-2px);
            box-shadow:0 6px 20px rgba(0,240,255,0.4);
        }

        .btn-custom-secondary {
            background: rgba(30,40,70,0.7);
            border:1px solid rgba(74,200,255,0.2);
            color:var(--text-primary);
            font-weight:500;
            padding:8px 16px;
            border-radius:8px;
            transition:all 0.3s ease;
            white-space:nowrap;
        }

        .btn-custom-secondary:hover {
            background: rgba(40,50,90,0.7);
            border-color: rgba(74,200,255,0.4);
        }

        .btn-custom-info {
            background: linear-gradient(90deg,#00b894,#00f0ff);
            border:none;
            color:#0b0f20;
            font-weight:600;
            padding:8px 16px;
            border-radius:8px;
            transition:all 0.3s ease;
        }

        .btn-custom-info:hover {
            transform:translateY(-2px);
            box-shadow:0 4px 15px rgba(0,240,255,0.4);
        }

        .table-custom {
            background:transparent;
            color:var(--text-primary);
            margin-bottom:0;
            width:100%;
        }

        .table-custom thead th {
            background: rgba(10,15,35,0.7);
            border-bottom:1px solid rgba(74,200,255,0.2);
            color:var(--accent-a);
            font-weight:600;
            padding:12px 15px;
            position:sticky;
            top:0;
            z-index:10;
        }

        .table-custom tbody td {
            border-bottom:1px solid rgba(74,200,255,0.1);
            padding:12px 15px;
            vertical-align:middle;
        }

        .table-custom tbody tr:hover {
            background: rgba(30,40,70,0.3);
        }

        .badge-custom-success {
            background: linear-gradient(90deg,#00b894,#00f0ff);
            color:#0b0f20;
            font-weight:600;
            padding:4px 8px;
            border-radius:12px;
            font-size:0.75rem;
        }

        .badge-custom-secondary {
            background: linear-gradient(90deg,#6c757d,#9aa3b2);
            color:#0b0f20;
            font-weight:600;
            padding:4px 8px;
            border-radius:12px;
            font-size:0.75rem;
        }

        .modal { z-index: 3000 !important; }
        .modal-backdrop { z-index: 2500 !important; }

        .modal-content-custom {
            background: var(--card-bg);
            border: 1px solid rgba(74,200,255,0.1);
            border-radius: 12px;
        }

        .modal-header-custom {
            background: rgba(10,15,35,0.7);
            border-bottom: 1px solid rgba(74,200,255,0.1);
        }

        .modal-title-custom { color: var(--text-primary); font-weight: 600; }
        .modal-body-custom { color: var(--text-primary); }
        .modal-footer-custom { background: rgba(10,15,35,0.7); border-top: 1px solid rgba(74,200,255,0.1); }

        .form-control-custom {
            background: rgba(20,25,45,0.7);
            border: 1px solid rgba(74,200,255,0.2);
            color: var(--text-primary);
            border-radius: 8px;
        }

        .form-control-custom:focus {
            background: rgba(20,25,45,0.9);
            border-color: var(--accent-a);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(0,240,255,0.25);
        }

        .form-control-custom:read-only {
            background: rgba(30,35,55,0.5);
            border-color: rgba(74,200,255,0.1);
            color: var(--text-secondary);
        }

        .form-label-custom {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .localizacao-item {
            background: rgba(20,25,45,0.5);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-a);
        }

        .localizacao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .localizacao-nome { font-weight: 600; color: var(--accent-a); }
        .localizacao-datas { font-size: 0.85rem; color: var(--text-secondary); }
        .loading-spinner { text-align: center; padding: 20px; color: var(--accent-a); }

        .endereco-completo { font-size: 0.85rem; color: var(--text-secondary); }
        .text-muted-custom { color: var(--muted) !important; }
        .codigo-publico { font-family: monospace; font-size: 0.8rem; background: rgba(0,240,255,0.1); padding: 2px 6px; border-radius: 4px; }

        /* Toast fixado acima do header */
        .toast-custom {
            background: var(--card-bg);
            border: 1px solid rgba(74,200,255,0.2);
            position: fixed;
            top: 90px;
            right: 25px;
            z-index: 4000 !important;
            min-width: 280px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
            animation: slideIn 0.4s ease, fadeOut 0.6s ease 4s forwards;
        }

        .toast-header-custom {
            background: rgba(10,15,35,0.7);
            border-bottom: 1px solid rgba(74,200,255,0.1);
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-15px); }
        }

        .btn:focus { outline: 2px solid rgba(0,240,255,0.12); }
    </style>
</head>
<body>
<div class="bg-wrapper">
    <div class="streak s1"></div>
    <div class="streak s2"></div>
    <div class="streak s3"></div>
    <div class="streak s4"></div>
</div>

<header th:replace="pages/component/header :: header"></header>

<div class="main-content">
    <div class="container-fluid">

        <div class="row justify-content-center">
            <div class="col-12 col-xl-12">
                <div class="card-custom">
                    <div class="card-header-custom">
                        <h2 class="card-title-custom">Dispositivos Cadastrados</h2>
                        <div>
                            <!-- Botão abre modal (Bootstrap vai adicionar backdrop automaticamente) -->
                            <button type="button" class="btn btn-custom-primary" data-bs-toggle="modal" data-bs-target="#vincularDispositivoModal">
                                <i class="bi bi-plus-circle"></i> Novo Dispositivo
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="contador-resultados mb-3">
                            <span class="text-muted">
                                Mostrando <span id="totalRegistros" th:text="${dispositivos.size()}">0</span> dispositivos
                            </span>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Código Público</th>
                                    <th>Nome</th>
                                    <th>Modelo</th>
                                    <th>Versão</th>
                                    <th>Localização</th>
                                    <th>Endereço</th>
                                    <th width="120px">Ações</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyDispositivos">
                                <tr th:each="dispositivo : ${dispositivos}">
                                    <td>
                                        <span class="text-muted-custom" th:text="${dispositivo.id}">ID</span>
                                    </td>
                                    <td>
                                        <span class="codigo-publico" th:text="${dispositivo.codigoPublicoDispositivo}">Código</span>
                                    </td>
                                    <td>
                                        <strong th:text="${dispositivo.nomeDoDispositivo}">Nome</strong>
                                    </td>
                                    <td th:text="${dispositivo.modeloDispositivo}">Modelo</td>
                                    <td>
                                        <span class="badge-custom-secondary" th:text="${dispositivo.versaoDoDispositivo}">Versão</span>
                                    </td>
                                    <td>
                                        <span th:if="${dispositivo.nomeDaLocalizacaoDoDispositivo}"
                                              th:text="${dispositivo.nomeDaLocalizacaoDoDispositivo}">Localização</span>
                                        <span th:unless="${dispositivo.nomeDaLocalizacaoDoDispositivo}"
                                              class="text-muted-custom">Sem localização</span>
                                    </td>
                                    <td>
                                        <div class="endereco-completo" th:if="${dispositivo.cidade}">
                                            <div th:text="${dispositivo.nomeDaRua} + ', ' + ${dispositivo.numero}">Rua, Número</div>
                                            <div th:text="${dispositivo.cidade}">Cidade</div>
                                            <div th:if="${dispositivo.complemento}"
                                                 th:text="'Comp: ' + ${dispositivo.complemento}">Complemento</div>
                                        </div>
                                        <span th:unless="${dispositivo.cidade}" class="text-muted-custom">Endereço não informado</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-custom-info btn-sm"
                                                th:attr="data-id=${dispositivo.id}"
                                                onclick="abrirModalDetalhes(this)">
                                            <i class="bi bi-clock-history"></i> Histórico
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast-container p-3">
    <div id="toastMensagem" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastTexto">Dispositivo vinculado com sucesso!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- MOVED MODALS: placing modals as direct children of body to avoid stacking/overflow issues -->

<!-- Modal Vincular Dispositivo -->
<div class="modal fade" id="vincularDispositivoModal" tabindex="-1" aria-labelledby="vincularDispositivoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-custom">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title modal-title-custom" id="vincularDispositivoModalLabel">Vincular Novo Dispositivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body modal-body-custom">
                <form id="vincularDispositivoForm" novalidate>
                    <div class="mb-3">
                        <label for="chipId" class="form-label-custom">
                            <i class="bi bi-cpu"></i> Chip ID do Dispositivo
                        </label>
                        <input type="number"
                               class="form-control form-control-custom"
                               id="chipId"
                               name="chipId"
                               placeholder="Digite o número do chipId"
                               required
                               min="1"
                               step="1">
                        <div class="form-text text-muted-custom">
                            Informe o código único do dispositivo físico
                        </div>
                        <div class="invalid-feedback" id="chipIdError">
                            Por favor, insira um chipId válido (número positivo).
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer-custom">
                <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-custom-primary" id="btnVincular">
                    <i class="bi bi-link-45deg"></i> Vincular Dispositivo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Histórico de Localizações -->
<div class="modal fade" id="detalhesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-content-custom">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title modal-title-custom">
                    <i class="bi bi-clock-history"></i> Histórico de Localizações
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body modal-body-custom">
                <div class="card-custom mb-4">
                    <div class="card-header-custom">
                        <h6 class="card-title-custom mb-0">Informações do Dispositivo</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">ID:</strong>
                                <span id="detailId" class="ms-2">-</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">Código Público:</strong>
                                <span id="detailCodigoPublico" class="ms-2 codigo-publico">-</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">Nome:</strong>
                                <span id="detailNome" class="ms-2">-</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">Modelo:</strong>
                                <span id="detailModelo" class="ms-2">-</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong class="form-label-custom">Versão:</strong>
                                <span id="detailVersao" class="ms-2 badge-custom-secondary">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-custom">
                    <div class="card-header-custom">
                        <h6 class="card-title-custom mb-0">Histórico de Localizações</h6>
                    </div>
                    <div class="card-body">
                        <div id="localizacoesContainer">
                            <div class="loading-spinner">
                                <i class="bi bi-arrow-repeat spinner"></i> Carregando histórico de localizações...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer modal-footer-custom">
                <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS (bundle includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
    // Variáveis globais
    let dispositivoAtualId = null;

    // Função para mostrar mensagens toast (corrigida)
    function mostrarMensagem(titulo, mensagem, tipo) {
        const toastEl = document.getElementById('mensagemToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');

        if (!toastEl) return;

        // Ajuste visual para ficar acima do header
        toastEl.style.zIndex = '9999';
        toastEl.style.position = 'fixed';
        toastEl.style.top = '80px';
        toastEl.style.left = '50%';
        toastEl.style.transform = 'translateX(-50%)';
        toastEl.style.transition = 'opacity 0.4s ease-in-out';

        const config = {
            success: { icon: 'bi-check-circle-fill', class: 'text-success' },
            error: { icon: 'bi-exclamation-triangle-fill', class: 'text-danger' },
            info: { icon: 'bi-info-circle', class: 'text-info' }
        }[tipo] || { icon: 'bi-info-circle', class: 'text-info' };

        toastIcon.className = `bi ${config.icon} ${config.class}`;
        toastTitle.textContent = titulo;
        toastMessage.textContent = mensagem;

        // Exibir o toast
        const toast = new bootstrap.Toast(toastEl);
        toast.show();

        // Garantir que fique visível mesmo se houver scroll
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
    }

    // Função para vincular dispositivo
    async function vincularDispositivo() {
        const chipIdInput = document.getElementById('chipId');
        if (!chipIdInput) return;
        const chipId = chipIdInput.value.trim();
        const vincularBtn = document.getElementById('btnVincular');

        if (!chipId || isNaN(chipId) || Number(chipId) <= 0) {
            chipIdInput.classList.add('is-invalid');
            return;
        }

        vincularBtn.disabled = true;
        const originalBtnHTML = vincularBtn.innerHTML;
        vincularBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Vinculando...';

        try {
            const formBody = new URLSearchParams();
            formBody.append('chipId', chipId);

            const response = await fetch('/home/config/vincular', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formBody.toString()
            });

            if (response.status === 201 || response.ok) {
                mostrarMensagem('Sucesso!', 'Dispositivo vinculado com sucesso!', 'success');

                const vincularModalEl = document.getElementById('vincularDispositivoModal');
                const vincularModal = bootstrap.Modal.getOrCreateInstance(vincularModalEl);

                setTimeout(() => {
                    vincularModal.hide();
                    chipIdInput.value = '';
                    location.reload();
                }, 1000);
            } else if (response.status === 400) {
                throw new Error('ChipId inválido ou já vinculado');
            } else if (response.status === 404) {
                throw new Error('Dispositivo não encontrado');
            } else if (response.status === 409) {
                throw new Error('Dispositivo já vinculado a outro usuário');
            } else {
                let text = 'Erro ao vincular dispositivo';
                try { text = await response.text() || text; } catch (e) {}
                throw new Error(text);
            }
        } catch (error) {
            mostrarMensagem('Erro!', error.message || 'Erro ao vincular', 'error');
        } finally {
            vincularBtn.disabled = false;
            vincularBtn.innerHTML = originalBtnHTML;
        }
    }

    // Abrir modal de detalhes
    function abrirModalDetalhes(button) {
        const dispositivoId = button.getAttribute('data-id');
        dispositivoAtualId = dispositivoId;

        const linha = button.closest('tr');
        const dispositivoData = {
            id: linha.querySelector('td:nth-child(1)').textContent.trim(),
            codigoPublico: linha.querySelector('td:nth-child(2)').textContent.trim(),
            nome: linha.querySelector('td:nth-child(3)').textContent.trim(),
            modelo: linha.querySelector('td:nth-child(4)').textContent.trim(),
            versao: linha.querySelector('td:nth-child(5)').textContent.trim()
        };

        document.getElementById('detailId').textContent = dispositivoData.id;
        document.getElementById('detailCodigoPublico').textContent = dispositivoData.codigoPublico;
        document.getElementById('detailNome').textContent = dispositivoData.nome;
        document.getElementById('detailModelo').textContent = dispositivoData.modelo;
        document.getElementById('detailVersao').textContent = dispositivoData.versao;

        carregarLocalizacoes(dispositivoId);

        const detalhesModalEl = document.getElementById('detalhesModal');
        const detalhesModal = bootstrap.Modal.getOrCreateInstance(detalhesModalEl);
        detalhesModal.show();
    }

    // Carregar localizações
    function carregarLocalizacoes(dispositivoId) {
        const container = document.getElementById('localizacoesContainer');
        container.innerHTML = '<div class="loading-spinner"><i class="bi bi-arrow-repeat spinner"></i> Carregando histórico...</div>';

        fetch(`/home/config/dispositivo/${dispositivoId}/localizacoes`)
            .then(response => response.ok ? response.json() : Promise.reject(response))
            .then(localizacoes => {
                container.innerHTML = localizacoes.length ?
                    localizacoes.map((loc, i) => `
                        <div class="localizacao-item">
                            <div class="localizacao-header">
                                <span class="localizacao-nome">
                                    <i class="bi bi-geo-alt"></i>
                                    ${loc.nomeDaLocalizacaoDoDispositivo || 'Localização não nomeada'}
                                </span>
                                <span class="badge-custom-secondary">${i + 1}</span>
                            </div>
                            <div class="localizacao-datas">
                                <strong>Período:</strong> ${formatarData(loc.dataInicio)} até ${loc.dataFim ? formatarData(loc.dataFim) : 'Atual'}
                            </div>
                        </div>
                    `).join('') :
                    '<div class="text-center text-muted py-4">Nenhuma localização registrada.</div>';
            })
            .catch(() => {
                container.innerHTML = '<div class="text-center text-danger py-4">Erro ao carregar histórico.</div>';
            });
    }

    // Formatar data
    function formatarData(dataString) {
        if (!dataString) return 'N/A';
        try {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR') + ' ' +
                data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        } catch {
            return dataString;
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const chipInput = document.getElementById('chipId');
        const vincularBtn = document.getElementById('btnVincular');
        const vincularModalEl = document.getElementById('vincularDispositivoModal');

        chipInput?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                vincularDispositivo();
            }
        });

        chipInput?.addEventListener('input', function() {
            this.classList.remove('is-invalid');
        });

        vincularBtn?.addEventListener('click', vincularDispositivo);

        vincularModalEl?.addEventListener('show.bs.modal', function() {
            chipInput?.classList.remove('is-invalid');
            if (chipInput) chipInput.value = '';
        });

        document.getElementById('detalhesModal')?.addEventListener('hidden.bs.modal', function() {
            dispositivoAtualId = null;
            document.getElementById('localizacoesContainer').innerHTML = '';
        });
    });
</script>
</body>
</html>
